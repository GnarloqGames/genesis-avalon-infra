---
kind: pipeline
type: kubernetes
name: default

image_pull_secrets:
- harborcreds

steps:
- name: build-and-push-builder-image
  image: docker:dind
  when:
    event:
      - tag
  volumes:
  - name: dockersock
    path: /var/run
  commands:
  - sleep 5 # give docker enough time to start
  - export IMAGE=registry.0x42.in/library/docker/genesis-avalon-builder:bookworm-${DRONE_TAG}
  - docker build -f ./docker/builder/Dockerfile $IMAGE
  - docker push $IMAGE

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}
---
kind: signature
hmac: 1afdd4fbb4f1b42b7c2db96bb7ebf1fccf8952314bfe3f7f975b344403aa8689